# 自定义镜像训练功能操作指南

# 1 自定义镜像概述

ModelArts提供了多种预置引擎，但是当用户对深度学习引擎、开发库有特殊需求的场景的时候，预置引擎已经不能满足用户需求。此时用户可以使用ModelArts自定义镜像这个功能来达到自定义运行引擎的目的。

ModelArts底层采用容器技术，自定义镜像指的是用户自行制作容器镜像并在ModelArts上运行。自定义镜像功能支持自由文本形式的命令行参数和环境变量，因此灵活性比较高，便于支持任意计算引擎的作业启动需求。

# 2 自定义镜像功能使用步骤

ModelArts中使用自定义功能步骤如下：

1. 制作自定义镜像。

2. 上传自定义镜像到华为云SWR。

3. 在ModelArts中使用自定义镜像创建作业。

## 2.1 制作自定义镜像

制作自定义镜像只需要往镜像中添加一些必要的深度学习库及用户自定义的模块。

自定义镜像有如下约束：

1. 自定义镜像必须基于ModelArts官方提供的基础镜像。

2. 自定义镜像中不能包含恶意代码。

3. 不能基础镜像中的部分内容不能改变，包括/bin、/sbin、/usr、/lib(64)下的所有文件，/etc下的部分重要配置文件，以及$HOME下的DLS小工具。

4. 不得新增属主为root且权限包含setuid或setgid位的文件。

5. 自定义镜像不能超过9.5G。

为了能让自定义镜像匹配ModelArts当前运行机制，ModelArts服务将一些必须软件及工具放在基础镜像中，所以用户需要基于ModelArts官方提供的基础镜像来制作自定义镜像，目前发布的基础镜像地址：

1. CPU镜像：

   ```
   swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-cpu-base:1.0
   ```

2. GPU镜像：

   ```
   swr.cn-north-1.myhuaweicloud.com/eiwizard/custom-gpu-cuda9-base:1.0
   ```

ModelArts会不定期更新基础镜像，基础镜像更新后，基于旧版本制作的自定义镜像将不能再ModelArts上运行，但已经运行过的自定义镜像可以继续使用。

当用户发现自定义镜像审核不通过，并且审核日志中报镜像不匹配的时候，就需要去更新基础镜像。公开的镜像没有页面可查询，文末会列出各个基础镜像的版本，用户取最新的使用。

用户可以通过如下两种方式制定自定义镜像：